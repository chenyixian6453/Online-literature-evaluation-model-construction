# check_data.py
import pymysql
from pymysql.cursors import DictCursor

# 数据库配置（使用你的配置）
DB_CONFIG = {
    "host": "localhost",
    "user": "root",
    "password": "Chenyixian6453!",
    "database": "novel_analysis",
    "charset": "utf8mb4"
}


def check_database_status():
    """检查数据库状态"""
    print("=== 数据库状态检查 ===")

    try:
        # 连接数据库
        conn = pymysql.connect(**DB_CONFIG)
        cursor = conn.cursor(DictCursor)

        # 1. 检查novel_base_info表
        print("1. 检查novel_base_info表...")
        cursor.execute("SELECT COUNT(*) as count FROM novel_base_info")
        base_count = cursor.fetchone()['count']
        print(f"  小说基本信息记录数: {base_count}")

        # 显示一些示例数据
        cursor.execute("SELECT work_id, work_name, work_url FROM novel_base_info LIMIT 5")
        samples = cursor.fetchall()
        print("  示例数据（前5条）:")
        for sample in samples:
            print(f"    ID:{sample['work_id']} - {sample['work_name']}")

        # 2. 检查novel_chapters表
        print("\n2. 检查novel_chapters表...")
        cursor.execute("SELECT COUNT(*) as count FROM novel_chapters")
        chapters_count = cursor.fetchone()['count']
        print(f"  章节记录数: {chapters_count}")

        # 3. 检查novel_comments表
        print("\n3. 检查novel_comments表...")
        cursor.execute("SELECT COUNT(*) as count FROM novel_comments")
        comments_count = cursor.fetchone()['count']
        print(f"  评论记录数: {comments_count}")

        # 4. 统计各表数据分布
        if chapters_count > 0:
            cursor.execute("""
                SELECT work_id, COUNT(*) as chapter_count 
                FROM novel_chapters 
                GROUP BY work_id 
                LIMIT 10
            """)
            print("\n  各小说章节数量（前10）:")
            for row in cursor.fetchall():
                print(f"    作品ID {row['work_id']}: {row['chapter_count']} 章")

        # 5. 检查未爬取的小说
        print("\n4. 检查待爬取的小说...")
        cursor.execute("""
            SELECT work_id, work_name, work_url 
            FROM novel_base_info 
            WHERE work_id NOT IN (SELECT DISTINCT work_id FROM novel_chapters)
            LIMIT 10
        """)
        uncrawled = cursor.fetchall()
        print(f"  未爬取章节的小说数量（前10）: {len(uncrawled)}")
        for novel in uncrawled:
            print(f"    ID:{novel['work_id']} - {novel['work_name']}")

        # 关闭连接
        cursor.close()
        conn.close()

        print("\n=== 检查完成 ===")
        return True

    except Exception as e:
        print(f"检查失败: {e}")
        return False


if __name__ == "__main__":
    check_database_status()